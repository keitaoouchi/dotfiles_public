#!/usr/bin/env bash
set -e

echo "Installing 1Password CLI..."

{{- if eq .chezmoi.os "darwin" }}
if ! command -v op &> /dev/null; then
  if command -v brew &> /dev/null; then
    brew install --cask 1password-cli
  else
    echo "Error: Homebrew not found. Please install Homebrew first."
    exit 1
  fi
else
  echo "1Password CLI already installed."
fi
{{- else if eq .chezmoi.os "linux" }}
if ! command -v op &> /dev/null; then
  echo "Downloading 1Password CLI..."
  curl -sSfo /tmp/op.zip https://cache.agilebits.com/dist/1P/op2/pkg/v2.23.0/op_linux_amd64_v2.23.0.zip
  sudo unzip -od /usr/local/bin/ /tmp/op.zip
  sudo chmod +x /usr/local/bin/op
  rm /tmp/op.zip
else
  echo "1Password CLI already installed."
fi
{{- end }}

# Verify op is available and authenticated
if ! op account list &> /dev/null; then
  echo ""
  echo "⚠️  1Password CLI installed but not authenticated."
  echo "Please run: eval \$(op signin)"
  echo "Then re-run: chezmoi apply"
  exit 1
fi

echo "1Password CLI installation complete and authenticated."
